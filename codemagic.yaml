# ==========================================
# CodeMagic CI/CD Configuration
# MakaNetu - Risk Place Angola
# ==========================================

workflows:
  # ==========================================
  # WORKFLOW: ANDROID DEVELOP
  # ==========================================
  android-develop:
    name: Android Development Build
    
    max_build_duration: 60
    
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - environment_vars_dev
        - common_environment
      
      vars:
        FLUTTER_VERSION: "3.35.7"
        PACKAGE_NAME: "ao.riskplace.makanetu"
        
      flutter: stable
      
      xcode: latest
      
      cocoapods: default
    
    triggering:
      events:
        - push
        - pull_request
      
      branch_patterns:
        - pattern: 'develop'
          include: true
          source: true
      
      cancel_previous_builds: true
    
    scripts:
      - name: ÔøΩ Get Flutter packages
        script: |
          flutter packages pub get
      
      - name: üîç Analyze code
        script: |
          flutter analyze
        ignore_failure: true
      
      - name: üß™ Run tests
        script: |
          flutter test
        ignore_failure: true
      
      - name: üèóÔ∏è Build Android APK (Development)
        script: |
          flutter build apk \
            --debug \
            --dart-define=ENV=$ENV \
            --dart-define=BASE_URL=$BASE_URL \
            --dart-define=WS_URL=$WS_URL \
            --dart-define=OSM_TILE_URL=$OSM_TILE_URL
      
      - name: üöÄ Upload to Firebase App Distribution
        script: |
          echo "Installing Firebase CLI..."
          npm install -g firebase-tools
          
          echo "Deploying to Firebase App Distribution..."
          firebase appdistribution:distribute \
            build/app/outputs/flutter-apk/app-debug.apk \
            --app $FIREBASE_APP_ID_ANDROID \
            --groups "nete-testers" \
            --release-notes "Development build - $(date)" \
            --token $FIREBASE_CLI_TOKEN
    
    artifacts:
      - build/app/outputs/**/*.apk
      - build/app/outputs/**/*.aab
      - build/app/outputs/**/mapping.txt
      - flutter_drive.log
    
    publishing:
      email:
        recipients:
          - $TEAM_EMAIL
        notify:
          success: true
          failure: true
      
      slack:
        channel: '#ci-cd-notifications'
        notify_on_build_start: true
        notify:
          success: true
          failure: true

  # ==========================================
  # WORKFLOW: ANDROID PRODUCTION
  # ==========================================
  android-production:
    name: Android Production Build
    
    max_build_duration: 90
    
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - common_environment
        - environment_vars_prod
        - google_play_credentials
      
      vars:
        FLUTTER_VERSION: "3.35.7"
        PACKAGE_NAME: "ao.riskplace.makanetu"
        GOOGLE_PLAY_TRACK: "internal"
        
      android_signing:
        - makaneto_keystore
      
      flutter: stable
      
      xcode: latest
      
      cocoapods: default
    
    triggering:
      events:
        - push
        - tag
      
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
        - pattern: 'release/*'
          include: true
          source: true
      
      cancel_previous_builds: false
    
    scripts:
      - name: ÔøΩ Get Flutter packages
        script: |
          flutter packages pub get
      
      - name: üîç Analyze code
        script: |
          flutter analyze
        ignore_failure: true
      
      - name: üß™ Run tests (Production)
        script: |
          flutter test
        ignore_failure: false
      
      - name: üî¢ Update version code
        script: |
          VERSION_NAME=$(grep 'version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          VERSION_CODE=$(($(grep 'version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f2) + 1))
          
          echo "Building version $VERSION_NAME+$VERSION_CODE"
          sed -i '' "s/version: .*/version: $VERSION_NAME+$VERSION_CODE/" pubspec.yaml
      
      - name: üèóÔ∏è Build Android App Bundle (Production)
        script: |
          flutter build appbundle \
            --release \
            --build-name=$VERSION_NAME \
            --build-number=$VERSION_CODE \
            --dart-define=ENV=$ENV \
            --dart-define=BASE_URL=$BASE_URL \
            --dart-define=WS_URL=$WS_URL \
            --dart-define=OSM_TILE_URL=$OSM_TILE_URL
      
      - name: üöÄ Publish to Google Play (Internal Testing)
        script: |
          echo "Publishing to Google Play Store - Internal Testing Track"
          
          # CodeMagic automaticamente publica usando as credenciais configuradas
          # A publica√ß√£o √© feita via Google Play Console API
    
    artifacts:
      - build/app/outputs/**/*.aab
      - build/app/outputs/**/mapping.txt
      - build/app/outputs/**/output-metadata.json
    
    publishing:
      # Publica√ß√£o no Google Play Store
      google_play:
        credentials: $GCLOUD_SERVICE_ACCOUNT_CREDENTIALS
        track: $GOOGLE_PLAY_TRACK
        submit_as_draft: false
        rollout_fraction: 0.1
        changes_not_sent_for_review: false
        in_app_update_priority: 3
      
      email:
        recipients:
          - $TEAM_EMAIL
          - $PRODUCT_OWNER_EMAIL
        notify:
          success: true
          failure: true
      
      slack:
        channel: '#releases'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
      
      # Notifica√ß√µes adicionais
      scripts:
        - name: üéâ Send release notification
          script: |
            echo "‚úÖ Nova vers√£o $VERSION_NAME+$VERSION_CODE publicada no Google Play Store!"
            echo "Track: Internal Testing"
            echo "Rollout: 10% dos usu√°rios"

  # ==========================================
  # WORKFLOW: iOS DEVELOP
  # ==========================================
  ios-develop:
    name: iOS Development Build
    
    max_build_duration: 60
    
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - common_environment
        - environment_vars_dev
        - app_store_credentials
      
      vars:
        FLUTTER_VERSION: "3.35.7"
        BUNDLE_ID: "ao.riskplace.makanetu"
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        
      flutter: stable
      
      xcode: latest
      
      cocoapods: default
      
      ios_signing:
        distribution_type: app_store
        bundle_identifier: ao.riskplace.makanetu
    
    triggering:
      events:
        - push
        - pull_request
      
      branch_patterns:
        - pattern: 'develop'
          include: true
          source: true
      
      cancel_previous_builds: true
    
    scripts:
      - name: üîê Setup signing (automatic)
        script: |
          echo "Using Xcode automatic signing"
          echo "Team ID: 4883KF3Z76"
          echo "Bundle ID: $BUNDLE_ID"

      
      - name: üîß Get Flutter packages
        script: |
          flutter packages pub get
      
      - name: üçé Install CocoaPods dependencies
        script: |
          cd ios
          pod install --repo-update
          echo "‚úÖ CocoaPods configured successfully"
      
      - name: üîç Analyze code
        script: |
          flutter analyze
        ignore_failure: true
      
      - name: üß™ Run tests
        script: |
          flutter test
        ignore_failure: true
      
      - name: üèóÔ∏è Build iOS IPA (Development)
        script: |
          flutter build ipa --release \
            --build-name=1.0.0 \
            --build-number=$BUILD_NUMBER \
            --dart-define=ENV=$ENV \
            --dart-define=BASE_URL=$BASE_URL \
            --dart-define=WS_URL=$WS_URL \
            --dart-define=OSM_TILE_URL=$OSM_TILE_URL
      
      - name: üöÄ Publish to TestFlight
        script: |
          echo "Publishing to TestFlight Beta..."
          # CodeMagic automaticamente publica usando App Store Connect API
    
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - flutter_drive.log
    
    publishing:
      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        
        submit_to_testflight: true
        beta_groups:
          - Nete Testers
          #- Internal Testers
          #- Beta Testers
        
        submit_to_app_store: false
      
      email:
        recipients:
          - $TEAM_EMAIL
        notify:
          success: true
          failure: true
      
      slack:
        channel: '#ci-cd-notifications'
        notify_on_build_start: true
        notify:
          success: true
          failure: true

  # ==========================================
  # WORKFLOW: iOS PRODUCTION
  # ==========================================
  ios-production:
    name: iOS Production Build
    
    max_build_duration: 90
    
    instance_type: mac_mini_m2
    
    environment:
      groups:
        - common_environment
        - environment_vars_prod
        - app_store_credentials
      
      vars:
        FLUTTER_VERSION: "3.35.7"
        BUNDLE_ID: "ao.riskplace.makanetu"
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        
      flutter: stable
      
      xcode: latest
      
      cocoapods: default
      
      ios_signing:
        distribution_type: app_store
        bundle_identifier: ao.riskplace.makanetu
    
    triggering:
      events:
        - push
        - tag
      
      branch_patterns:
        - pattern: 'main'
          include: true
          source: true
        - pattern: 'release/*'
          include: true
          source: true
      
      cancel_previous_builds: false
    
    scripts:
      - name: üîê Setup signing (automatic)
        script: |
          echo "Using Xcode automatic signing"
          echo "Team ID: 4883KF3Z76"
          echo "Bundle ID: $BUNDLE_ID"
      
      - name: üîß Get Flutter packages
        script: |
          flutter packages pub get
      
      - name: üçé Install CocoaPods dependencies
        script: |
          cd ios
          pod install --repo-update
          echo "‚úÖ CocoaPods configured successfully"
      
      - name: üîç Analyze code
        script: |
          flutter analyze
        ignore_failure: true
      
      - name: üß™ Run tests (Production)
        script: |
          flutter test
        ignore_failure: false
      
      - name: üî¢ Update version code
        script: |
          VERSION_NAME=$(grep 'version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f1)
          VERSION_CODE=$(($(grep 'version:' pubspec.yaml | sed 's/version: //' | cut -d'+' -f2) + 1))
          
          echo "Building version $VERSION_NAME+$VERSION_CODE"
          sed -i '' "s/version: .*/version: $VERSION_NAME+$VERSION_CODE/" pubspec.yaml
      
      - name: üèóÔ∏è Build iOS IPA (Production)
        script: |
          flutter build ipa --release \
            --build-name=$VERSION_NAME \
            --build-number=$VERSION_CODE \
            --dart-define=ENV=$ENV \
            --dart-define=BASE_URL=$BASE_URL \
            --dart-define=WS_URL=$WS_URL \
            --dart-define=OSM_TILE_URL=$OSM_TILE_URL
      
      - name: üöÄ Publish to App Store
        script: |
          echo "Publishing to App Store..."
          # CodeMagic automaticamente publica usando App Store Connect API
    
    artifacts:
      - build/ios/ipa/*.ipa
      - /tmp/xcodebuild_logs/*.log
      - ios/**/GeneratedPluginRegistrant.m
    
    publishing:
      app_store_connect:
        api_key: $APP_STORE_CONNECT_PRIVATE_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        
        # Primeiro vai para TestFlight
        submit_to_testflight: true
        beta_groups:
          - Internal Testers
        
        # Depois submete para review da App Store
        submit_to_app_store: true
        
        release_type: MANUAL
        
        # Informa√ß√µes para App Store
        copyright: "2025 Risk Place Angola"
        
      email:
        recipients:
          - $TEAM_EMAIL
          - $PRODUCT_OWNER_EMAIL
        notify:
          success: true
          failure: true
      
      slack:
        channel: '#releases'
        notify_on_build_start: true
        notify:
          success: true
          failure: true
