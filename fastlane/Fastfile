# Fastlane configuration for MakaNetu (Risk Place Angola)
# This file contains the fastlane.tools configuration

default_platform(:ios)

# ==========================================
# iOS Platform
# ==========================================
platform :ios do
  before_all do
    setup_ci if ENV['CI']
  end

  # ==========================================
  # LANE: Development Build (TestFlight)
  # ==========================================
  desc "Build and distribute iOS development build to TestFlight"
  lane :dev do
    # Setup API key first to fetch latest build number
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_filepath: ENV['APP_STORE_CONNECT_API_KEY_PATH']
    )
    
    # Get latest build number from TestFlight
    latest_build = latest_testflight_build_number(
      api_key: api_key,
      app_identifier: "ao.riskplace.makanetu"
    )
    
    # Increment build number
    increment_build_number(
      xcodeproj: "ios/Runner.xcodeproj",
      build_number: latest_build + 1
    )

    # Get certificates and provisioning profiles using match
    match(
      type: "appstore",
      readonly: true,
      app_identifier: "ao.riskplace.makanetu",
      git_url: ENV['MATCH_GIT_URL']
    )

    # Build the app
    build_ios_app(
      workspace: "ios/Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      xcargs: "-allowProvisioningUpdates",
      export_options: {
        provisioningProfiles: {
          "ao.riskplace.makanetu" => "match AppStore ao.riskplace.makanetu"
        }
      },
      output_directory: "./build/ios",
      output_name: "makanetu-dev.ipa"
    )

    # Upload to TestFlight with tester groups (api_key already configured above)
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: true,
      distribute_external: true,
      notify_external_testers: true,
      groups: ["Nete Testers"],
      changelog: "Development build #{ENV['GITHUB_RUN_NUMBER']} - #{Time.now.strftime('%Y-%m-%d %H:%M')}"
    )
  end

  # ==========================================
  # LANE: Production Release (TestFlight + App Store)
  # ==========================================
  desc "Build, upload to TestFlight and submit for App Store review"
  lane :beta do
    # Setup API key first to fetch latest build number
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_filepath: ENV['APP_STORE_CONNECT_API_KEY_PATH']
    )
    
    # Get latest build number from TestFlight
    latest_build = latest_testflight_build_number(
      api_key: api_key,
      app_identifier: "ao.riskplace.makanetu"
    )
    
    # Increment build number
    increment_build_number(
      xcodeproj: "ios/Runner.xcodeproj",
      build_number: latest_build + 1
    )

    # Get certificates and provisioning profiles using match
    match(
      type: "appstore",
      readonly: true,
      app_identifier: "ao.riskplace.makanetu",
      git_url: ENV['MATCH_GIT_URL']
    )

    # Build the app
    build_ios_app(
      workspace: "ios/Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      xcargs: "-allowProvisioningUpdates",
      export_options: {
        provisioningProfiles: {
          "ao.riskplace.makanetu" => "match AppStore ao.riskplace.makanetu"
        }
      },
      output_directory: "./build/ios",
      output_name: "makanetu-prod.ipa"
    )

    # Upload to TestFlight first (api_key already configured above)
    upload_to_testflight(
      api_key: api_key,
      skip_waiting_for_build_processing: false,  # Aguardar processamento
      distribute_external: true,
      notify_external_testers: true,
      groups: ["Nete Testers"],
      changelog: "Production build #{ENV['GITHUB_RUN_NUMBER']}"
    )
    
    # Note: Submit for App Store Review should be done manually after testing
    # or create a separate lane for submission
  end

  # ==========================================
  # LANE: Submit to App Store Review (Manual)
  # ==========================================
  desc "Submit the latest TestFlight build to App Store Review"
  lane :release do
    api_key = app_store_connect_api_key(
      key_id: ENV['APP_STORE_CONNECT_API_KEY_ID'],
      issuer_id: ENV['APP_STORE_CONNECT_ISSUER_ID'],
      key_filepath: ENV['APP_STORE_CONNECT_API_KEY_PATH']
    )
    
    deliver(
      api_key: api_key,
      submit_for_review: true,
      automatic_release: false,
      force: true,
      skip_binary_upload: true,  # Use existing TestFlight build
      skip_metadata: false,
      skip_screenshots: false,
      precheck_include_in_app_purchases: false,
      submission_information: {
        add_id_info_uses_idfa: false
      }
    )
  end

  # ==========================================
  # LANE: Setup Certificates (Match)
  # ==========================================
  desc "Setup certificates and provisioning profiles"
  lane :setup_certificates do
    match(
      type: "development",
      app_identifier: "ao.riskplace.makanetu",
      readonly: false
    )

    match(
      type: "appstore",
      app_identifier: "ao.riskplace.makanetu",
      readonly: false
    )
  end
end

# ==========================================
# Android Platform
# ==========================================
platform :android do
  before_all do
    setup_ci if ENV['CI']
  end

  # ==========================================
  # LANE: Development Build (Firebase)
  # ==========================================
  desc "Build and distribute Android development build to Firebase"
  lane :dev do
    # Build the app
    gradle(
      task: "assemble",
      build_type: "Debug",
      project_dir: "android/"
    )

    # Upload to Firebase App Distribution
    firebase_app_distribution(
      app: ENV['FIREBASE_APP_ID_ANDROID'],
      groups: "nete-testers",
      release_notes: "Development build #{ENV['GITHUB_RUN_NUMBER']} - #{Time.now.strftime('%Y-%m-%d %H:%M')}",
      android_artifact_type: "APK",
      android_artifact_path: "build/app/outputs/flutter-apk/app-debug.apk",
      firebase_cli_token: ENV['FIREBASE_CLI_TOKEN']
    )
  end

  # ==========================================
  # LANE: Production Testing (Internal + Open Testing)
  # ==========================================
  desc "Build and upload to Google Play Internal and Open Testing"
  lane :beta do
    # Build the app bundle
    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "android/"
    )

    # Upload to Internal Testing first (obrigatório para novos apps)
    upload_to_play_store(
      package_name: "ao.riskplace.makanetu",
      track: "internal",
      aab: "build/app/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      release_status: "completed",
      rollout: "1.0"
    )

    # Aguardar alguns segundos para processar
    sleep(10)

    # Promover para Open Testing (14 dias obrigatórios)
    upload_to_play_store(
      package_name: "ao.riskplace.makanetu",
      track: "internal",
      track_promote_to: "beta",
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_apk: true,
      skip_upload_aab: true,
      release_status: "completed",
      rollout: "1.0"
    )
  end

  # ==========================================
  # LANE: Production Release
  # ==========================================
  desc "Build and submit to Google Play Store"
  lane :release do
    # Build the app bundle
    gradle(
      task: "bundle",
      build_type: "Release",
      project_dir: "android/"
    )

    # Upload to Google Play Production
    upload_to_play_store(
      package_name: "ao.riskplace.makanetu",
      track: "production",
      aab: "build/app/outputs/bundle/release/app-release.aab",
      skip_upload_metadata: false,
      skip_upload_images: false,
      skip_upload_screenshots: false,
      release_status: "draft",
      rollout: "0.1"
    )
  end
end
